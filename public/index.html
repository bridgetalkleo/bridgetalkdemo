<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BridgeTalk â€“ YazÄ± + Sesli Mesaj</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 760px; margin: 0 auto; padding: 16px; }
    .row { display: flex; gap: 8px; margin: 8px 0; }
    .msg { border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 6px 0; }
    .ai { background: #f6f8ff; }
    .me { background: #f7fff6; }
    .broadcast { background: #fffbe6; }
    small { color: #666; }
    button { padding: 6px 10px; }
  </style>
</head>
<body>
  <h2>BridgeTalk â€“ YazÄ± + Sesli Mesaj</h2>

  <div class="row">
    <input id="conversationId" placeholder="KonuÅŸma ID (boÅŸsa yeni aÃ§Ä±lÄ±r)" style="flex:1">
    <input id="displayName" placeholder="AdÄ±n" style="flex:1">
    <button id="startBtn">BaÅŸla</button>
  </div>

  <div id="inviteBox" style="display:none" class="msg">
    <b>Davet Linki:</b>
    <div><code id="inviteLink"></code></div>
    <small>Bu linki diÄŸer tarafa gÃ¶nder. O da aynÄ± odaya girecek.</small>
  </div>

  <div id="feed"></div>

  <!-- YazÄ± mesaj -->
  <div class="row">
    <input id="text" placeholder="Mesaj yaz..." style="flex:1">
    <button id="sendBtn">GÃ¶nder</button>
  </div>

  <!-- Ses kaydÄ± -->
  <div class="row">
    <button id="recordBtn">ğŸ™ Ses Kaydet</button>
    <button id="stopBtn" disabled>â¹ Durdur</button>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let socket, participantId, conversationId;
    let mediaRecorder, audioChunks = [];

    const feed = document.getElementById("feed");
    function addMsg(cls, text) {
      const div = document.createElement("div");
      div.className = "msg " + cls;
      div.textContent = text;
      feed.appendChild(div);
      feed.scrollTop = feed.scrollHeight;
    }

    async function start() {
      const name = document.getElementById("displayName").value || "Anon";
      let cid = document.getElementById("conversationId").value.trim();

      if (!cid) {
        const r = await fetch("/api/create-conversation", { 
          method:"POST", 
          headers:{ "Content-Type":"application/json"},
          body: JSON.stringify({ topic: "" })
        });
        const js = await r.json();
        cid = js.conversationId;
        document.getElementById("conversationId").value = cid;

        document.getElementById("inviteBox").style.display = "block";
        document.getElementById("inviteLink").textContent = `${location.origin}/join/${cid}`;
      }

      const join = await fetch("/api/join", { 
        method:"POST", 
        headers:{ "Content-Type":"application/json"},
        body: JSON.stringify({ conversationId: cid, displayName: name })
      });
      const jr = await join.json();
      participantId = jr.participantId;
      conversationId = cid;

      socket = io("/", { transports:["websocket"] });
      socket.on("connect", () => socket.emit("joinRoom", { conversationId, participantId }));
      socket.on("aiMessage", ({ text }) => addMsg("ai", text));
      socket.on("aiBroadcast", ({ text }) => addMsg("broadcast", text));
      socket.on("userEcho", (m) => addMsg("me", m.text));

      addMsg("ai", "BaÄŸlandÄ±n. AI seni karÅŸÄ±layacak; olayÄ± serbestÃ§e anlatabilirsin.");
    }

    function send() {
      const text = document.getElementById("text").value.trim();
      if (!text) {
        alert("LÃ¼tfen bir mesaj yaz");
        return;
      }
      if (!socket) {
        alert("Ã–nce 'BaÅŸla' butonuna basmalÄ±sÄ±n!");
        return;
      }
      console.log("Mesaj gÃ¶nderiliyor:", text);
      socket.emit("userMessage", { text });
      document.getElementById("text").value = "";
    }

    // Ses kaydÄ± baÅŸlat
    document.getElementById("recordBtn").addEventListener("click", async () => {
      if (!socket) {
        alert("Ã–nce 'BaÅŸla' butonuna basmalÄ±sÄ±n!");
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob, "recording.webm");

        const resp = await fetch("/api/upload-audio", { method: "POST", body: formData });
        const data = await resp.json();
        if (data?.text) {
          socket.emit("userMessage", { text: data.text });
        } else {
          alert("Ses metne Ã§evrilemedi.");
        }
      };
      mediaRecorder.start();
      document.getElementById("recordBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    });

    // Ses kaydÄ± durdur
    document.getElementById("stopBtn").addEventListener("click", () => {
      mediaRecorder.stop();
      document.getElementById("recordBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    });

    document.getElementById("startBtn").onclick = start;
    document.getElementById("sendBtn").onclick = send;
    document.getElementById("text").addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });
  </script>
</body>
</html>
